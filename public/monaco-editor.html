<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de FÃ³rmulas KPI</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #1e1e1e;
            overflow: hidden;
        }
        #editor {
            width: 100%;
            height: 100vh;
        }
        .toolbar {
            background: #252526;
            padding: 8px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toolbar button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .toolbar button:hover {
            background: #1177bb;
        }
        .toolbar .info {
            color: #d4d4d4;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="info">
            ðŸ’¡ Escribe una letra para ver sugerencias automÃ¡ticas
        </div>
        <button onclick="saveAndClose()">âœ“ Guardar</button>
    </div>
    <div id="editor"></div>

    <script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>
    <script>
        // Recibir fÃ³rmula inicial desde el parent
        const initialValue = new URLSearchParams(window.location.search).get('value') || '';

        // Funciones del sistema con sus parÃ¡metros completos
        const SYSTEM_FUNCTIONS = [
            {
                name: 'COUNT_PRIORITIES',
                signature: 'COUNT_PRIORITIES(filtros?)',
                detail: 'ðŸ“Š Sistema',
                params: ['status', 'type', 'userName', 'initiativeName', 'projectName', 'clientName', 'isCarriedOver', 'weekStart', 'weekEnd', 'completionMin', 'completionMax']
            },
            {
                name: 'SUM_PRIORITIES',
                signature: 'SUM_PRIORITIES(campo, filtros?)',
                detail: 'ðŸ“Š Sistema',
                params: ['status', 'type', 'userName', 'initiativeName', 'projectName']
            },
            {
                name: 'AVG_PRIORITIES',
                signature: 'AVG_PRIORITIES(campo, filtros?)',
                detail: 'ðŸ“Š Sistema',
                params: ['status', 'type', 'userName', 'initiativeName', 'projectName']
            },
            {
                name: 'COUNT_MILESTONES',
                signature: 'COUNT_MILESTONES(filtros?)',
                detail: 'ðŸ“Š Sistema',
                params: ['userName', 'projectName', 'isCompleted', 'dueDateStart', 'dueDateEnd']
            },
            {
                name: 'COUNT_PROJECTS',
                signature: 'COUNT_PROJECTS(filtros?)',
                detail: 'ðŸ“Š Sistema',
                params: ['isActive', 'projectManagerName']
            },
            {
                name: 'COUNT_USERS',
                signature: 'COUNT_USERS(filtros?)',
                detail: 'ðŸ“Š Sistema',
                params: ['role', 'area', 'isActive', 'isAreaLeader']
            },
            {
                name: 'COMPLETION_RATE',
                signature: 'COMPLETION_RATE(filtros?)',
                detail: 'ðŸ“Š Sistema',
                params: ['userName', 'initiativeName', 'projectName', 'weekStart', 'weekEnd', 'status']
            },
            {
                name: 'PERCENTAGE',
                signature: 'PERCENTAGE(parte, total)',
                detail: 'ðŸ“Š Sistema',
                params: []
            }
        ];

        // Datos de autocompletado (se cargarÃ¡n del servidor)
        let autocompleteData = null;

        // Cargar datos de autocompletado
        async function loadAutocompleteData() {
            try {
                const response = await fetch('/api/kpis/autocomplete-data');
                if (response.ok) {
                    autocompleteData = await response.json();
                }
            } catch (error) {
                console.warn('No se pudieron cargar datos de autocompletado:', error);
            }
        }

        loadAutocompleteData();

        // Funciones de Excel completas (382 funciones de hot-formula-parser)
        const EXCEL_FUNCTIONS = [
  { name: 'ABS', signature: 'ABS()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'ACCRINT', signature: 'ACCRINT()', detail: 'ðŸ’° Financieras' },
  { name: 'ACOS', signature: 'ACOS()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'ACOSH', signature: 'ACOSH()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'ACOT', signature: 'ACOT()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'ACOTH', signature: 'ACOTH()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'ADD', signature: 'ADD()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'AGGREGATE', signature: 'AGGREGATE()', detail: 'ðŸ“¦ Otras' },
  { name: 'AND', signature: 'AND()', detail: 'ðŸ”€ LÃ³gicas' },
  { name: 'ARABIC', signature: 'ARABIC()', detail: 'ðŸ“¦ Otras' },
  { name: 'ARGS2ARRAY', signature: 'ARGS2ARRAY()', detail: 'ðŸ“¦ Otras' },
  { name: 'ASIN', signature: 'ASIN()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'ASINH', signature: 'ASINH()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'ATAN', signature: 'ATAN()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'ATAN2', signature: 'ATAN2()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'ATANH', signature: 'ATANH()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'AVEDEV', signature: 'AVEDEV()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'AVERAGE', signature: 'AVERAGE()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'AVERAGEA', signature: 'AVERAGEA()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'AVERAGEIF', signature: 'AVERAGEIF()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'AVERAGEIFS', signature: 'AVERAGEIFS()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'BASE', signature: 'BASE()', detail: 'ðŸ“¦ Otras' },
  { name: 'BESSELI', signature: 'BESSELI()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'BESSELJ', signature: 'BESSELJ()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'BESSELK', signature: 'BESSELK()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'BESSELY', signature: 'BESSELY()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'BETADIST', signature: 'BETADIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'BETAINV', signature: 'BETAINV()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'BIN2DEC', signature: 'BIN2DEC()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'BIN2HEX', signature: 'BIN2HEX()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'BIN2OCT', signature: 'BIN2OCT()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'BINOMDIST', signature: 'BINOMDIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'BITAND', signature: 'BITAND()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'BITLSHIFT', signature: 'BITLSHIFT()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'BITOR', signature: 'BITOR()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'BITRSHIFT', signature: 'BITRSHIFT()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'BITXOR', signature: 'BITXOR()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'CEILING', signature: 'CEILING()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'CEILINGMATH', signature: 'CEILINGMATH()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'CEILINGPRECISE', signature: 'CEILINGPRECISE()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'CHAR', signature: 'CHAR()', detail: 'ðŸ“ Texto' },
  { name: 'CHOOSE', signature: 'CHOOSE()', detail: 'ðŸ”§ Utilidades' },
  { name: 'CLEAN', signature: 'CLEAN()', detail: 'ðŸ“ Texto' },
  { name: 'CODE', signature: 'CODE()', detail: 'ðŸ“ Texto' },
  { name: 'COLUMN', signature: 'COLUMN()', detail: 'ðŸ”§ Utilidades' },
  { name: 'COLUMNS', signature: 'COLUMNS()', detail: 'ðŸ”§ Utilidades' },
  { name: 'COMBIN', signature: 'COMBIN()', detail: 'ðŸ”§ Utilidades' },
  { name: 'COMBINA', signature: 'COMBINA()', detail: 'ðŸ”§ Utilidades' },
  { name: 'COMPLEX', signature: 'COMPLEX()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'CONCATENATE', signature: 'CONCATENATE()', detail: 'ðŸ“ Texto' },
  { name: 'CONFIDENCE', signature: 'CONFIDENCE()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'CONVERT', signature: 'CONVERT()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'CORREL', signature: 'CORREL()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'COS', signature: 'COS()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'COSH', signature: 'COSH()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'COT', signature: 'COT()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'COTH', signature: 'COTH()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'COUNT', signature: 'COUNT()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'COUNTA', signature: 'COUNTA()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'COUNTBLANK', signature: 'COUNTBLANK()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'COUNTIF', signature: 'COUNTIF()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'COUNTIFS', signature: 'COUNTIFS()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'COUNTIN', signature: 'COUNTIN()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'COUNTUNIQUE', signature: 'COUNTUNIQUE()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'CSC', signature: 'CSC()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'CSCH', signature: 'CSCH()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'CUMIPMT', signature: 'CUMIPMT()', detail: 'ðŸ’° Financieras' },
  { name: 'CUMPRINC', signature: 'CUMPRINC()', detail: 'ðŸ’° Financieras' },
  { name: 'DATE', signature: 'DATE()', detail: 'ðŸ“… Fechas' },
  { name: 'DATEVALUE', signature: 'DATEVALUE()', detail: 'ðŸ“… Fechas' },
  { name: 'DAY', signature: 'DAY()', detail: 'ðŸ“… Fechas' },
  { name: 'DAYS', signature: 'DAYS()', detail: 'ðŸ“… Fechas' },
  { name: 'DAYS360', signature: 'DAYS360()', detail: 'ðŸ“… Fechas' },
  { name: 'DB', signature: 'DB()', detail: 'ðŸ’° Financieras' },
  { name: 'DDB', signature: 'DDB()', detail: 'ðŸ’° Financieras' },
  { name: 'DEC2BIN', signature: 'DEC2BIN()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'DEC2HEX', signature: 'DEC2HEX()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'DEC2OCT', signature: 'DEC2OCT()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'DECIMAL', signature: 'DECIMAL()', detail: 'ðŸ“¦ Otras' },
  { name: 'DEGREES', signature: 'DEGREES()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'DELTA', signature: 'DELTA()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'DEVSQ', signature: 'DEVSQ()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'DIVIDE', signature: 'DIVIDE()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'DOLLARDE', signature: 'DOLLARDE()', detail: 'ðŸ’° Financieras' },
  { name: 'DOLLARFR', signature: 'DOLLARFR()', detail: 'ðŸ’° Financieras' },
  { name: 'E', signature: 'E()', detail: 'ðŸ”§ Utilidades' },
  { name: 'EDATE', signature: 'EDATE()', detail: 'ðŸ“… Fechas' },
  { name: 'EFFECT', signature: 'EFFECT()', detail: 'ðŸ’° Financieras' },
  { name: 'EOMONTH', signature: 'EOMONTH()', detail: 'ðŸ“… Fechas' },
  { name: 'EQ', signature: 'EQ()', detail: 'ðŸ“¦ Otras' },
  { name: 'ERF', signature: 'ERF()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'ERFC', signature: 'ERFC()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'EVEN', signature: 'EVEN()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'EXACT', signature: 'EXACT()', detail: 'ðŸ“ Texto' },
  { name: 'EXP', signature: 'EXP()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'EXPONDIST', signature: 'EXPONDIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'FACT', signature: 'FACT()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'FACTDOUBLE', signature: 'FACTDOUBLE()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'FALSE', signature: 'FALSE()', detail: 'ðŸ”€ LÃ³gicas' },
  { name: 'FDIST', signature: 'FDIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'FDISTRT', signature: 'FDISTRT()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'FIND', signature: 'FIND()', detail: 'ðŸ“ Texto' },
  { name: 'FINV', signature: 'FINV()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'FINVRT', signature: 'FINVRT()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'FISHER', signature: 'FISHER()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'FISHERINV', signature: 'FISHERINV()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'FLATTEN', signature: 'FLATTEN()', detail: 'ðŸ”§ Utilidades' },
  { name: 'FLOOR', signature: 'FLOOR()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'FORECAST', signature: 'FORECAST()', detail: 'ðŸ”§ Utilidades' },
  { name: 'FREQUENCY', signature: 'FREQUENCY()', detail: 'ðŸ”§ Utilidades' },
  { name: 'FV', signature: 'FV()', detail: 'ðŸ’° Financieras' },
  { name: 'FVSCHEDULE', signature: 'FVSCHEDULE()', detail: 'ðŸ’° Financieras' },
  { name: 'GAMMA', signature: 'GAMMA()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'GAMMADIST', signature: 'GAMMADIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'GAMMAINV', signature: 'GAMMAINV()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'GAMMALN', signature: 'GAMMALN()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'GAUSS', signature: 'GAUSS()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'GCD', signature: 'GCD()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'GEOMEAN', signature: 'GEOMEAN()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'GESTEP', signature: 'GESTEP()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'GROWTH', signature: 'GROWTH()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'GTE', signature: 'GTE()', detail: 'ðŸ“¦ Otras' },
  { name: 'HARMEAN', signature: 'HARMEAN()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'HEX2BIN', signature: 'HEX2BIN()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'HEX2DEC', signature: 'HEX2DEC()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'HEX2OCT', signature: 'HEX2OCT()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'HOUR', signature: 'HOUR()', detail: 'ðŸ“… Fechas' },
  { name: 'HTML2TEXT', signature: 'HTML2TEXT()', detail: 'ðŸ“¦ Otras' },
  { name: 'HYPGEOMDIST', signature: 'HYPGEOMDIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'IF', signature: 'IF()', detail: 'ðŸ”€ LÃ³gicas' },
  { name: 'IMABS', signature: 'IMABS()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMAGINARY', signature: 'IMAGINARY()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMARGUMENT', signature: 'IMARGUMENT()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMCONJUGATE', signature: 'IMCONJUGATE()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMCOS', signature: 'IMCOS()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMCOSH', signature: 'IMCOSH()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMCOT', signature: 'IMCOT()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMCSC', signature: 'IMCSC()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMCSCH', signature: 'IMCSCH()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMDIV', signature: 'IMDIV()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMEXP', signature: 'IMEXP()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMLN', signature: 'IMLN()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMLOG10', signature: 'IMLOG10()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMLOG2', signature: 'IMLOG2()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMPOWER', signature: 'IMPOWER()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMPRODUCT', signature: 'IMPRODUCT()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMREAL', signature: 'IMREAL()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMSEC', signature: 'IMSEC()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMSECH', signature: 'IMSECH()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMSIN', signature: 'IMSIN()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMSINH', signature: 'IMSINH()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMSQRT', signature: 'IMSQRT()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMSUB', signature: 'IMSUB()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMSUM', signature: 'IMSUM()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'IMTAN', signature: 'IMTAN()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'INT', signature: 'INT()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'INTERCEPT', signature: 'INTERCEPT()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'INTERVAL', signature: 'INTERVAL()', detail: 'ðŸ“… Fechas' },
  { name: 'IPMT', signature: 'IPMT()', detail: 'ðŸ’° Financieras' },
  { name: 'IRR', signature: 'IRR()', detail: 'ðŸ’° Financieras' },
  { name: 'ISBINARY', signature: 'ISBINARY()', detail: 'ðŸ”§ Utilidades' },
  { name: 'ISBLANK', signature: 'ISBLANK()', detail: 'ðŸ”§ Utilidades' },
  { name: 'ISEVEN', signature: 'ISEVEN()', detail: 'ðŸ”§ Utilidades' },
  { name: 'ISLOGICAL', signature: 'ISLOGICAL()', detail: 'ðŸ”§ Utilidades' },
  { name: 'ISNONTEXT', signature: 'ISNONTEXT()', detail: 'ðŸ”§ Utilidades' },
  { name: 'ISNUMBER', signature: 'ISNUMBER()', detail: 'ðŸ”§ Utilidades' },
  { name: 'ISODD', signature: 'ISODD()', detail: 'ðŸ”§ Utilidades' },
  { name: 'ISOWEEKNUM', signature: 'ISOWEEKNUM()', detail: 'ðŸ“… Fechas' },
  { name: 'ISPMT', signature: 'ISPMT()', detail: 'ðŸ’° Financieras' },
  { name: 'ISTEXT', signature: 'ISTEXT()', detail: 'ðŸ”§ Utilidades' },
  { name: 'JOIN', signature: 'JOIN()', detail: 'ðŸ“ Texto' },
  { name: 'KURT', signature: 'KURT()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'LARGE', signature: 'LARGE()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'LCM', signature: 'LCM()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'LEFT', signature: 'LEFT()', detail: 'ðŸ“ Texto' },
  { name: 'LEN', signature: 'LEN()', detail: 'ðŸ“ Texto' },
  { name: 'LINEST', signature: 'LINEST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'LN', signature: 'LN()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'LOG', signature: 'LOG()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'LOG10', signature: 'LOG10()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'LOGEST', signature: 'LOGEST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'LOGNORMDIST', signature: 'LOGNORMDIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'LOGNORMINV', signature: 'LOGNORMINV()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'LOWER', signature: 'LOWER()', detail: 'ðŸ“ Texto' },
  { name: 'LT', signature: 'LT()', detail: 'ðŸ“¦ Otras' },
  { name: 'LTE', signature: 'LTE()', detail: 'ðŸ“¦ Otras' },
  { name: 'MATCH', signature: 'MATCH()', detail: 'ðŸ”§ Utilidades' },
  { name: 'MAX', signature: 'MAX()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'MAXA', signature: 'MAXA()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'MEDIAN', signature: 'MEDIAN()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'MID', signature: 'MID()', detail: 'ðŸ“ Texto' },
  { name: 'MIN', signature: 'MIN()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'MINA', signature: 'MINA()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'MINUS', signature: 'MINUS()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'MINUTE', signature: 'MINUTE()', detail: 'ðŸ“… Fechas' },
  { name: 'MIRR', signature: 'MIRR()', detail: 'ðŸ’° Financieras' },
  { name: 'MOD', signature: 'MOD()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'MODEMULT', signature: 'MODEMULT()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'MODESNGL', signature: 'MODESNGL()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'MONTH', signature: 'MONTH()', detail: 'ðŸ“… Fechas' },
  { name: 'MROUND', signature: 'MROUND()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'MULTINOMIAL', signature: 'MULTINOMIAL()', detail: 'ðŸ”§ Utilidades' },
  { name: 'MULTIPLY', signature: 'MULTIPLY()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'NE', signature: 'NE()', detail: 'ðŸ“¦ Otras' },
  { name: 'NEGBINOMDIST', signature: 'NEGBINOMDIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'NETWORKDAYS', signature: 'NETWORKDAYS()', detail: 'ðŸ“… Fechas' },
  { name: 'NOMINAL', signature: 'NOMINAL()', detail: 'ðŸ’° Financieras' },
  { name: 'NORMDIST', signature: 'NORMDIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'NORMINV', signature: 'NORMINV()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'NORMSDIST', signature: 'NORMSDIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'NORMSINV', signature: 'NORMSINV()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'NOT', signature: 'NOT()', detail: 'ðŸ”€ LÃ³gicas' },
  { name: 'NOW', signature: 'NOW()', detail: 'ðŸ“… Fechas' },
  { name: 'NPER', signature: 'NPER()', detail: 'ðŸ’° Financieras' },
  { name: 'NPV', signature: 'NPV()', detail: 'ðŸ’° Financieras' },
  { name: 'NUMBERS', signature: 'NUMBERS()', detail: 'ðŸ”§ Utilidades' },
  { name: 'OCT2BIN', signature: 'OCT2BIN()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'OCT2DEC', signature: 'OCT2DEC()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'OCT2HEX', signature: 'OCT2HEX()', detail: 'âš™ï¸ IngenierÃ­a' },
  { name: 'ODD', signature: 'ODD()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'OR', signature: 'OR()', detail: 'ðŸ”€ LÃ³gicas' },
  { name: 'PDURATION', signature: 'PDURATION()', detail: 'ðŸ’° Financieras' },
  { name: 'PEARSON', signature: 'PEARSON()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'PERCENTILEEXC', signature: 'PERCENTILEEXC()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'PERCENTILEINC', signature: 'PERCENTILEINC()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'PERCENTRANKEXC', signature: 'PERCENTRANKEXC()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'PERCENTRANKINC', signature: 'PERCENTRANKINC()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'PERMUT', signature: 'PERMUT()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'PERMUTATIONA', signature: 'PERMUTATIONA()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'PHI', signature: 'PHI()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'PI', signature: 'PI()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'PMT', signature: 'PMT()', detail: 'ðŸ’° Financieras' },
  { name: 'POISSONDIST', signature: 'POISSONDIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'POW', signature: 'POW()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'POWER', signature: 'POWER()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'PPMT', signature: 'PPMT()', detail: 'ðŸ’° Financieras' },
  { name: 'PROB', signature: 'PROB()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'PRODUCT', signature: 'PRODUCT()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'PROPER', signature: 'PROPER()', detail: 'ðŸ“ Texto' },
  { name: 'PV', signature: 'PV()', detail: 'ðŸ“¦ Otras' },
  { name: 'QUARTILEEXC', signature: 'QUARTILEEXC()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'QUARTILEINC', signature: 'QUARTILEINC()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'QUOTIENT', signature: 'QUOTIENT()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'RADIANS', signature: 'RADIANS()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'RAND', signature: 'RAND()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'RANDBETWEEN', signature: 'RANDBETWEEN()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'RANKAVG', signature: 'RANKAVG()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'RANKEQ', signature: 'RANKEQ()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'RATE', signature: 'RATE()', detail: 'ðŸ’° Financieras' },
  { name: 'REFERENCE', signature: 'REFERENCE()', detail: 'ðŸ”§ Utilidades' },
  { name: 'REGEXEXTRACT', signature: 'REGEXEXTRACT()', detail: 'ðŸ“ Texto' },
  { name: 'REGEXMATCH', signature: 'REGEXMATCH()', detail: 'ðŸ“ Texto' },
  { name: 'REGEXREPLACE', signature: 'REGEXREPLACE()', detail: 'ðŸ“ Texto' },
  { name: 'REPLACE', signature: 'REPLACE()', detail: 'ðŸ“ Texto' },
  { name: 'REPT', signature: 'REPT()', detail: 'ðŸ“ Texto' },
  { name: 'RIGHT', signature: 'RIGHT()', detail: 'ðŸ“ Texto' },
  { name: 'ROMAN', signature: 'ROMAN()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'ROUND', signature: 'ROUND()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'ROUNDDOWN', signature: 'ROUNDDOWN()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'ROUNDUP', signature: 'ROUNDUP()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'ROW', signature: 'ROW()', detail: 'ðŸ”§ Utilidades' },
  { name: 'ROWS', signature: 'ROWS()', detail: 'ðŸ”§ Utilidades' },
  { name: 'RRI', signature: 'RRI()', detail: 'ðŸ’° Financieras' },
  { name: 'RSQ', signature: 'RSQ()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'SEARCH', signature: 'SEARCH()', detail: 'ðŸ“ Texto' },
  { name: 'SEC', signature: 'SEC()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'SECH', signature: 'SECH()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'SECOND', signature: 'SECOND()', detail: 'ðŸ“… Fechas' },
  { name: 'SERIESSUM', signature: 'SERIESSUM()', detail: 'ðŸ”§ Utilidades' },
  { name: 'SIGN', signature: 'SIGN()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'SIN', signature: 'SIN()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'SINH', signature: 'SINH()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'SKEW', signature: 'SKEW()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'SKEWP', signature: 'SKEWP()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'SLN', signature: 'SLN()', detail: 'ðŸ’° Financieras' },
  { name: 'SLOPE', signature: 'SLOPE()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'SMALL', signature: 'SMALL()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'SPLIT', signature: 'SPLIT()', detail: 'ðŸ“ Texto' },
  { name: 'SQRT', signature: 'SQRT()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'SQRTPI', signature: 'SQRTPI()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'STANDARDIZE', signature: 'STANDARDIZE()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'STDEVA', signature: 'STDEVA()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'STDEVP', signature: 'STDEVP()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'STDEVPA', signature: 'STDEVPA()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'STDEVS', signature: 'STDEVS()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'STEYX', signature: 'STEYX()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'SUBSTITUTE', signature: 'SUBSTITUTE()', detail: 'ðŸ“ Texto' },
  { name: 'SUBTOTAL', signature: 'SUBTOTAL()', detail: 'ðŸ“¦ Otras' },
  { name: 'SUM', signature: 'SUM()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'SUMIF', signature: 'SUMIF()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'SUMIFS', signature: 'SUMIFS()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'SUMPRODUCT', signature: 'SUMPRODUCT()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'SUMSQ', signature: 'SUMSQ()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'SUMX2MY2', signature: 'SUMX2MY2()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'SUMX2PY2', signature: 'SUMX2PY2()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'SUMXMY2', signature: 'SUMXMY2()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'SWITCH', signature: 'SWITCH()', detail: 'ðŸ”€ LÃ³gicas' },
  { name: 'SYD', signature: 'SYD()', detail: 'ðŸ’° Financieras' },
  { name: 'T', signature: 'T()', detail: 'ðŸ“ Texto' },
  { name: 'TAN', signature: 'TAN()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'TANH', signature: 'TANH()', detail: 'ðŸ“ TrigonomÃ©tricas' },
  { name: 'TBILLEQ', signature: 'TBILLEQ()', detail: 'ðŸ’° Financieras' },
  { name: 'TBILLPRICE', signature: 'TBILLPRICE()', detail: 'ðŸ’° Financieras' },
  { name: 'TBILLYIELD', signature: 'TBILLYIELD()', detail: 'ðŸ’° Financieras' },
  { name: 'TDIST', signature: 'TDIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'TDIST2T', signature: 'TDIST2T()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'TDISTRT', signature: 'TDISTRT()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'TIME', signature: 'TIME()', detail: 'ðŸ“… Fechas' },
  { name: 'TIMEVALUE', signature: 'TIMEVALUE()', detail: 'ðŸ“… Fechas' },
  { name: 'TINV', signature: 'TINV()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'TINV2T', signature: 'TINV2T()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'TODAY', signature: 'TODAY()', detail: 'ðŸ“… Fechas' },
  { name: 'TRANSPOSE', signature: 'TRANSPOSE()', detail: 'ðŸ”§ Utilidades' },
  { name: 'TREND', signature: 'TREND()', detail: 'ðŸ”§ Utilidades' },
  { name: 'TRIM', signature: 'TRIM()', detail: 'ðŸ“ Texto' },
  { name: 'TRIMMEAN', signature: 'TRIMMEAN()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'TRUE', signature: 'TRUE()', detail: 'ðŸ”€ LÃ³gicas' },
  { name: 'TRUNC', signature: 'TRUNC()', detail: 'ðŸ”¢ MatemÃ¡ticas' },
  { name: 'UNICHAR', signature: 'UNICHAR()', detail: 'ðŸ“ Texto' },
  { name: 'UNICODE', signature: 'UNICODE()', detail: 'ðŸ“ Texto' },
  { name: 'UNIQUE', signature: 'UNIQUE()', detail: 'ðŸ”§ Utilidades' },
  { name: 'UPPER', signature: 'UPPER()', detail: 'ðŸ“ Texto' },
  { name: 'VARA', signature: 'VARA()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'VARP', signature: 'VARP()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'VARPA', signature: 'VARPA()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'VARS', signature: 'VARS()', detail: 'ðŸ“Š EstadÃ­sticas' },
  { name: 'WEEKDAY', signature: 'WEEKDAY()', detail: 'ðŸ“… Fechas' },
  { name: 'WEEKNUM', signature: 'WEEKNUM()', detail: 'ðŸ“… Fechas' },
  { name: 'WEIBULLDIST', signature: 'WEIBULLDIST()', detail: 'ðŸ“ˆ Distribuciones' },
  { name: 'WORKDAY', signature: 'WORKDAY()', detail: 'ðŸ“… Fechas' },
  { name: 'XIRR', signature: 'XIRR()', detail: 'ðŸ’° Financieras' },
  { name: 'XNPV', signature: 'XNPV()', detail: 'ðŸ’° Financieras' },
  { name: 'XOR', signature: 'XOR()', detail: 'ðŸ”€ LÃ³gicas' },
  { name: 'YEAR', signature: 'YEAR()', detail: 'ðŸ“… Fechas' },
  { name: 'YEARFRAC', signature: 'YEARFRAC()', detail: 'ðŸ“… Fechas' }
        ];

        let editor;

        require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@latest/min/vs' } });

        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: decodeURIComponent(initialValue),
                language: 'plaintext',
                theme: 'vs-dark',
                fontSize: 14,
                minimap: { enabled: false },
                lineNumbers: 'off',
                wordWrap: 'on',
                quickSuggestions: {
                    other: true,
                    comments: false,
                    strings: false,
                },
                quickSuggestionsDelay: 10,
                suggestOnTriggerCharacters: true,
                wordBasedSuggestions: 'off',
                suggest: {
                    showWords: false,
                    showSnippets: true,
                    filterGraceful: true,
                },
            });

            // Registrar provider con autocompletado de parÃ¡metros
            monaco.languages.registerCompletionItemProvider('plaintext', {
                triggerCharacters: ['(', ',', ' ', ':', '"', '{'],

                provideCompletionItems: function(model, position) {
                    const word = model.getWordUntilPosition(position);
                    const range = {
                        startLineNumber: position.lineNumber,
                        endLineNumber: position.lineNumber,
                        startColumn: word.startColumn,
                        endColumn: word.endColumn,
                    };

                    const textUntilPosition = model.getValueInRange({
                        startLineNumber: 1,
                        startColumn: 1,
                        endLineNumber: position.lineNumber,
                        endColumn: position.column,
                    });

                    const lineText = model.getLineContent(position.lineNumber);
                    const beforeCursor = lineText.substring(0, position.column - 1);
                    const wordUpper = word.word.toUpperCase();

                    let suggestions = [];

                    // Detectar si estamos dentro de una funciÃ³n del sistema
                    const inSystemFunction = SYSTEM_FUNCTIONS.find(fn => {
                        const functionStart = textUntilPosition.lastIndexOf(fn.name + '(');
                        if (functionStart === -1) return false;

                        const afterFunction = textUntilPosition.substring(functionStart);
                        const openParens = (afterFunction.match(/\(/g) || []).length;
                        const closeParens = (afterFunction.match(/\)/g) || []).length;

                        return openParens > closeParens;
                    });

                    // Detectar si estamos dentro de {}
                    const insideObjectBraces = () => {
                        let braceCount = 0;
                        for (let i = textUntilPosition.length - 1; i >= 0; i--) {
                            if (textUntilPosition[i] === '}') braceCount++;
                            if (textUntilPosition[i] === '{') {
                                braceCount--;
                                if (braceCount < 0) return true;
                            }
                        }
                        return false;
                    };

                    // Detectar si estamos dentro de ""
                    const insideQuotes = () => {
                        const quotesBeforeCursor = (beforeCursor.match(/"/g) || []).length;
                        return quotesBeforeCursor % 2 === 1;
                    };

                    if (inSystemFunction && autocompleteData) {
                        // Estamos dentro de una funciÃ³n del sistema

                        // Detectar si estamos escribiendo el valor de un parÃ¡metro (despuÃ©s de ":")
                        const paramValueMatch = beforeCursor.match(/(\w+):\s*"([^"]*)$/);

                        if (paramValueMatch) {
                            const paramName = paramValueMatch[1];

                            // Autocompletar valores segÃºn el parÃ¡metro
                            if (paramName === 'status') {
                                suggestions = autocompleteData.statuses.map(status => ({
                                    label: status.label,
                                    kind: monaco.languages.CompletionItemKind.EnumMember,
                                    detail: status.description,
                                    insertText: status.value,
                                    range: range,
                                    sortText: '0' + status.label,
                                }));
                            } else if (paramName === 'userName' || paramName === 'projectManagerName') {
                                suggestions = autocompleteData.users.map(user => ({
                                    label: user.label,
                                    kind: monaco.languages.CompletionItemKind.User,
                                    detail: `Ãrea: ${user.area || 'N/A'}`,
                                    insertText: user.value,
                                    range: range,
                                    sortText: '0' + user.name,
                                }));
                            } else if (paramName === 'projectName') {
                                suggestions = autocompleteData.projects.map(project => ({
                                    label: project.label,
                                    kind: monaco.languages.CompletionItemKind.Module,
                                    detail: 'Proyecto',
                                    insertText: project.value,
                                    range: range,
                                    sortText: '0' + project.name,
                                }));
                            } else if (paramName === 'initiativeName') {
                                suggestions = autocompleteData.initiatives.map(initiative => ({
                                    label: initiative.label,
                                    kind: monaco.languages.CompletionItemKind.Class,
                                    detail: 'Iniciativa EstratÃ©gica',
                                    insertText: initiative.value,
                                    range: range,
                                    sortText: '0' + initiative.name,
                                }));
                            } else if (paramName === 'clientName') {
                                suggestions = autocompleteData.clients.map(client => ({
                                    label: client.label,
                                    kind: monaco.languages.CompletionItemKind.Reference,
                                    detail: 'Cliente',
                                    insertText: client.value,
                                    range: range,
                                    sortText: '0' + client.name,
                                }));
                            } else if (paramName === 'area') {
                                suggestions = autocompleteData.areas.map(area => ({
                                    label: area.label,
                                    kind: monaco.languages.CompletionItemKind.Folder,
                                    detail: 'Ãrea',
                                    insertText: area.value,
                                    range: range,
                                    sortText: '0' + area.value,
                                }));
                            } else if (paramName === 'role') {
                                suggestions = autocompleteData.roles.map(role => ({
                                    label: role.label,
                                    kind: monaco.languages.CompletionItemKind.EnumMember,
                                    detail: role.description,
                                    insertText: role.value,
                                    range: range,
                                    sortText: '0' + role.label,
                                }));
                            }
                        } else if (insideObjectBraces() && !insideQuotes()) {
                            // Estamos dentro de {} pero NO dentro de comillas
                            // Sugerir nombres de parÃ¡metros
                            const availableParams = inSystemFunction.params;

                            suggestions = availableParams.map(param => {
                                let detail = 'ParÃ¡metro';
                                let insertText = `${param}: `;

                                if (param.includes('Name')) {
                                    detail = 'Nombre (autocompletado disponible)';
                                    insertText = `${param}: ""`;
                                } else if (param === 'status') {
                                    detail = 'Estado (autocompletado disponible)';
                                    insertText = `${param}: ""`;
                                } else if (param.startsWith('is')) {
                                    detail = 'Booleano (true/false)';
                                    insertText = `${param}: true`;
                                } else if (param.includes('Date') || param.includes('week')) {
                                    detail = 'Fecha (formato: "YYYY-MM-DD")';
                                    insertText = `${param}: "2025-01-01"`;
                                } else if (param.includes('Min') || param.includes('Max')) {
                                    detail = 'NÃºmero (0-100)';
                                    insertText = `${param}: 0`;
                                }

                                return {
                                    label: param,
                                    kind: monaco.languages.CompletionItemKind.Property,
                                    detail: detail,
                                    insertText: insertText,
                                    range: range,
                                    sortText: '0' + param,
                                };
                            });
                        }
                    }

                    // Si no hay sugerencias contextuales, mostrar funciones
                    if (suggestions.length === 0) {
                        const systemSuggestions = SYSTEM_FUNCTIONS
                            .filter(func => wordUpper === '' || func.name.toUpperCase().startsWith(wordUpper))
                            .slice(0, 5)
                            .map(func => ({
                                label: {
                                    label: func.name,
                                    description: func.signature,
                                },
                                kind: monaco.languages.CompletionItemKind.Function,
                                detail: func.detail,
                                insertText: func.name + '()',
                                range: range,
                                sortText: '!' + func.name,
                                filterText: func.name,
                            }));

                        const excelSuggestions = EXCEL_FUNCTIONS
                            .filter(func => wordUpper === '' || func.name.toUpperCase().startsWith(wordUpper))
                            .slice(0, 5)
                            .map(func => ({
                                label: {
                                    label: func.name,
                                    description: func.signature,
                                },
                                kind: monaco.languages.CompletionItemKind.Function,
                                detail: func.detail,
                                insertText: func.name + '()',
                                range: range,
                                sortText: '!!' + func.name,
                                filterText: func.name,
                            }));

                        suggestions = [...systemSuggestions, ...excelSuggestions];
                    }

                    return {
                        suggestions: suggestions,
                        incomplete: false,
                    };
                },
            });

            // Auto-resize
            window.addEventListener('resize', () => {
                editor.layout();
            });
        });

        function saveAndClose() {
            const value = editor.getValue();
            // Enviar mensaje al parent (React)
            window.parent.postMessage({ type: 'FORMULA_SAVE', value: value }, '*');
        }

        // Permitir que el parent pida el valor actual
        window.addEventListener('message', (event) => {
            if (event.data.type === 'GET_VALUE') {
                const value = editor.getValue();
                event.source.postMessage({ type: 'FORMULA_VALUE', value: value }, event.origin);
            }
        });
    </script>
</body>
</html>
